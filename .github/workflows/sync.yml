name: Sync Government Support Data

on:
  # Manual trigger
  workflow_dispatch:
    inputs:
      source:
        description: 'Source to sync (all, kstartup, bokjiro-central, bokjiro-local, bizinfo-rss)'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - kstartup
          - bokjiro-central
          - bokjiro-local
          - bizinfo-rss

  # Backup schedule (daily at 4 AM UTC, 1 hour after Vercel cron)
  schedule:
    - cron: '0 4 * * *'

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Trigger sync
        run: |
          SOURCE="${{ github.event.inputs.source || 'all' }}"
          BASE_URL="${{ secrets.APP_URL }}"
          SYNC_SECRET="${{ secrets.SYNC_SECRET }}"

          if [ "$SOURCE" = "all" ]; then
            ENDPOINTS=("kstartup" "bokjiro-central" "bokjiro-local" "bizinfo-rss")
          else
            ENDPOINTS=("$SOURCE")
          fi

          FAILED=0
          for endpoint in "${ENDPOINTS[@]}"; do
            echo "::group::Syncing $endpoint"
            HTTP_STATUS=$(curl -s -o response.json -w "%{http_code}" \
              -X POST \
              -H "Authorization: Bearer $SYNC_SECRET" \
              "${BASE_URL}/api/sync/${endpoint}")

            echo "Status: $HTTP_STATUS"
            cat response.json | python3 -m json.tool 2>/dev/null || cat response.json
            echo ""
            echo "::endgroup::"

            if [ "$HTTP_STATUS" -ne 200 ]; then
              echo "::error::Sync $endpoint failed with status $HTTP_STATUS"
              FAILED=$((FAILED + 1))
            fi
          done

          if [ $FAILED -gt 0 ]; then
            echo "::error::$FAILED sync(s) failed"
            exit 1
          fi

      - name: Check sync status
        if: always()
        run: |
          BASE_URL="${{ secrets.APP_URL }}"
          SYNC_SECRET="${{ secrets.SYNC_SECRET }}"

          curl -s \
            -H "Authorization: Bearer $SYNC_SECRET" \
            "${BASE_URL}/api/sync/status" | python3 -m json.tool 2>/dev/null || echo "Status check failed"
